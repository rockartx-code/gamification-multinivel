<section class="antialiased">
  <ui-header variant="dashboard"
    containerClass="mx-auto max-w-6xl flex w-full items-center justify-between gap-4 px-4 py-3 sm:px-6 sm:py-4">
    <!-- IZQUIERDA (hijo directo) -->
    <div header-left class="relative lg:hidden shrink-0">
      <ui-button size="lg" variant="ghost" type="button" (pressed)="toggleMobileNav()">
        <i class="fa-solid" [ngClass]="isMobileNavOpen ? 'fa-xmark' : 'fa-bars'" aria-hidden="true"></i>
      </ui-button>

      <div
        class="absolute left-0 mt-2 w-56 rounded-2xl border border-olive-30 bg-sand-200-90 p-2 shadow-xl backdrop-blur"
        [class.hidden]="!isMobileNavOpen">
        <ui-sidebar-nav [links]="dashboardNavLinks" [compact]="true" (linkSelect)="handleDashboardNavSelect($event)">
        </ui-sidebar-nav>

        <ui-button size="sm" variant="ghost" *ngIf="isGuest" class="mt-1 w-full rounded-xl" [routerLink]="['/login']"
          (pressed)="closeMobileNav()">
          <i class="fa-solid fa-right-to-bracket" aria-hidden="true"></i>
          Iniciar sesion
        </ui-button>
      </div>
    </div>

    <!-- DERECHA (hijo directo) -->
    <div class="flex shrink-0 items-center gap-2 sm:gap-3">
      <div *ngIf="currentUser" class="relative shrink-0">
        <ui-button size="sm" variant="ghost" type="button" (pressed)="toggleUserDetails()" aria-label="Usuario">
          <span id="user-circle-control" class="relative grid h-9 w-9 place-items-center rounded-full bg-ivory-80"
            [ngClass]="discountRingClass()">
            <i class="fa-solid fa-user text-[13px]" [ngClass]="levelIconClass()" aria-hidden="true"></i>

            <span *ngIf="isClient"
              class="absolute -right-1 -bottom-1 inline-flex items-center gap-1 rounded-full border border-olive-30 bg-sand-200-90 px-1.5 py-0.5 text-[9px] font-semibold leading-none shadow-sm backdrop-blur"
              [ngClass]="discountBadgeMiniClass()">
              <i class="fa-solid fa-tag text-[9px]" aria-hidden="true"></i>
              <span>{{ discountPercent }}%</span>
            </span>
          </span>

          <span class="name hidden max-w-[120px] truncate text-sm font-semibold lg:block">
            {{ currentUser.name }}
          </span>
        </ui-button>

        <div *ngIf="isUserDetailsOpen"
          class="absolute right-0 top-full z-50 mt-2 w-72 rounded-2xl border border-olive-30 bg-sand-200-90 p-4 shadow-xl backdrop-blur">
          <div class="flex items-center justify-between text-sm">
            <span class="meta text-xs">Usuario</span>
            <span class="font-semibold text-main">{{ currentUser.name }}</span>
          </div>

          <div class="meta mt-2 flex items-center justify-between text-xs">
            <span>Rol</span>
            <span class="text-main">{{ currentUser.role }}</span>
          </div>

          <div *ngIf="isClient" class="meta mt-2 flex items-center justify-between text-xs">
            <span>Descuento</span>
            <span class="text-main">{{ discountPercent }}%</span>
          </div>

          <ui-button size="sm" variant="ghost" *ngIf="!isGuest" type="button" class="mt-3 w-full" (pressed)="logout()">
            <i class="fa-solid fa-right-from-bracket" aria-hidden="true"></i>
            Cerrar sesion
          </ui-button>
        </div>
      </div>

      <nav class="hidden lg:flex items-center gap-2">
        <ui-button size="sm" variant="ghost" *ngFor="let l of dashboardNavLinks" type="button"
          (pressed)="scrollToSection(l.id)">
          <i class="fa-solid" [ngClass]="l.icon" aria-hidden="true"></i>
          <span>{{ l.label }}</span>
        </ui-button>

        <ui-button size="sm" variant="ghost" *ngIf="isGuest" [routerLink]="['/login']">
          <i class="fa-solid fa-right-to-bracket" aria-hidden="true"></i>
          Iniciar sesion
        </ui-button>
      </nav>
    </div>
  </ui-header>



  <main class="mx-auto max-w-6xl space-y-16 px-6 py-10">
    <section class="space-y-4">
      <div class="flex items-center justify-between" *ngIf="!isGuest">
        <div class="flex items-center gap-2 text-sm text-gray-600">
          <i class="fa-solid fa-chart-line" aria-hidden="true"></i>
          Progreso mensual
        </div>

        <ui-button size="sm" variant="ghost" (pressed)="toggleSecondaryGoals()">
          <i class="fa-solid fa-sliders" aria-hidden="true"></i>
          {{ secondaryGoalsVisible ? 'Ocultar metas secundarias' : 'Mostrar metas secundarias' }}
        </ui-button>
      </div>

      <div *ngIf="!isGuest && activeGoal">
        <div class="grain relative overflow-hidden rounded-3xl border border-gold-35 bg-gold-20 p-5 sm:p-6 md:p-8"
          [id]="'goal-' + activeGoal.key">
          <div class="pointer-events-none absolute inset-0 bg-olive-10">
          </div>

          <!-- Corte de mes: en móvil va en flujo; en md+ se fija arriba derecha -->
          <div class="kpi-mini relative mb-4 px-4 py-3 md:mb-0 md:absolute md:right-6 md:top-6"
            [ngClass]="getCountdownColor()" title="Cada dia sin accion reduce tu margen.">
            <div class="label flex items-center gap-2">
              <i class="fa-solid fa-calendar-days" aria-hidden="true"></i>
              Corte de mes
            </div>
            <div class="value text-lg tracking-tight">
              {{ countdownLabel() }}
            </div>
          </div>

          <div class="relative flex flex-col gap-5">
            <!-- Reservar espacio SOLO en md+ para el badge -->
            <div class="md:pr-56">
              <div class="text-sm font-semibold text-gold">Objetivo principal del mes</div>
              <h3 class="mt-2 text-2xl font-extrabold tracking-tight md:text-3xl">
                {{ activeGoal.title }}
              </h3>
              <p class="mt-2 text-sm text-muted">{{ activeGoal.subtitle }}</p>

              <!-- ojo: en móvil, evita "líneas eternas" -->
              <ui-goal-progress title="Objetivo principal del mes" [subtitle]="activeGoal.title"
                [currentValue]="activeGoal.base || 0" [cartValue]="activeGoal.cart || 0"
                [targetValue]="activeGoal.target || 0">
                <div class="mt-3 text-sm text-muted break-words">
                  Te faltan {{ remainingForGoal(activeGoal) }} para lograrlo
                </div>
              </ui-goal-progress>
            </div>

            <!-- CTA: móvil en flujo y full-width; md+ absoluto -->
            <ui-button size="lg" variant="primary" type="button"
              class="w-full md:absolute md:bottom-6 md:right-6 md:w-auto"
              (pressed)="scrollToSection(activeGoal.ctaFragment)">
              <i class="fa-solid fa-bullseye" aria-hidden="true"></i>
              {{ activeGoal.ctaText }}
            </ui-button>

            <!-- Espaciador SOLO en md+ para que el contenido no quede debajo del botón absoluto -->
            <div class="hidden md:block md:h-14"></div>
          </div>
        </div>
      </div>

      <div *ngIf="isGuest">
        <div class="grain relative overflow-hidden rounded-3xl border border-gold-35 bg-gold-20 p-6 md:p-8">
          <div class="pointer-events-none absolute inset-0 bg-olive-10">
          </div>
          <div class="relative flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
            <div>
              <div class="text-sm font-semibold text-gold"> <i class="fa-solid fa-bullseye" aria-hidden="true"></i> Meta
                para invitados</div>
              <h3 class="mt-2 text-2xl font-extrabold tracking-tight md:text-3xl">Regístrate para obtener beneficios
              </h3>
              <p class="mt-2 text-sm text-muted">Crea tu cuenta para desbloquear descuentos y seguimiento de tu red.
              </p>
            </div>
            <ui-button size="lg" variant="primary" type="button" (pressed)="openGuestRegisterModal()">
              <i class="fa-solid fa-user-plus" aria-hidden="true"></i>
              Registrate
            </ui-button>
          </div>
        </div>
      </div>

      <div class="grid gap-3 lg:grid-cols-4" *ngIf="!isGuest && secondaryGoalsVisible">
        <div *ngFor="let goal of secondaryGoals"
          class="grain relative overflow-hidden rounded-2xl border border-olive-30 bg-ivory-80 p-4 opacity-70"
          [id]="'goal-' + goal.key">
          <div class="goal-card" [attr.data-goal]="goal.key">
            <div class="text-xs text-gray-600">{{ goal.subtitle }}</div>

            <div class="mt-3 flex items-center justify-between text-xs text-gray-600">
              <span>{{ goalProgressLabel(goal) }}</span>
              <span *ngIf="goal.cart > 0" class="text-gold">+{{ formatMoney(goal.cart) }} en carrito</span>
            </div>

            <div class="progress relative mt-2 h-3">
              <div class="progress-fill" [style.width.%]="goalBasePercent(goal)"></div>
              <div class="progress-fill progress-fill-secondary" [style.left.%]="goalBasePercent(goal)"
                [style.width.%]="goalCartPercent(goal)"></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="merchant" class="scroll-mt-10">
      <div class="flex items-end justify-between gap-6">
        <div>
          <h2 class="flex items-center gap-3 text-3xl font-extrabold tracking-tight md:text-4xl">
            <i class="fa-solid fa-store hidden text-gold md:inline" aria-hidden="true"></i>
            Tienda
          </h2>
        </div>

        <div class="hidden items-center gap-3 md:flex">
          <div class="rounded-2xl border border-olive-30 bg-ivory-80 px-4 py-3">
            <div class="flex items-center gap-2 text-xs text-gray-600">
              <i class="fa-solid fa-cart-shopping" aria-hidden="true"></i>
              Carrito
            </div>
            <div class="text-lg font-extrabold">{{ formatMoney(cartTotal) }}</div>
            <div class="mt-1 text-[11px]" [ngClass]="cartDiscount > 0 ? 'text-accent' : 'text-gray-500'">
              {{ cartDiscount > 0 ? ('-' + formatMoney(cartDiscount) + ' • ' + cartDiscountLabel) : 'Sin descuento' }}
            </div>
          </div>
          <ui-button size="lg" variant="primary" type="button" (pressed)="goToCart()">
            <i class="fa-solid fa-basket-shopping" aria-hidden="true"></i>
            Ver carrito
          </ui-button>
        </div>
      </div>

      <div class="grain relative mt-8 overflow-hidden rounded-3xl border border-olive-30 bg-ambient">
        <div class="absolute inset-0 bg-olive-10">
        </div>
        <div class="relative grid items-center gap-8 p-6 md:grid-cols-2 md:p-10" *ngIf="productOfMonth as pom">

          <div class="order-2 md:order-2">
            <span
              class="inline-flex items-center gap-2 rounded-full border border-gold-35 bg-gold-20 px-4 py-2 text-xs font-semibold text-gold">
              <i class="fa-solid fa-star" aria-hidden="true"></i>
              Producto del mes | Recomendado para metas
            </span>
            <h3 class="mt-5 text-3xl font-extrabold tracking-tight md:text-4xl">{{ pom.name }}</h3>
            <p *ngIf="heroGoalHint" class="mt-2 text-sm text-gold">{{ heroGoalHint }}</p>
            <p class="mt-3 max-w-xl text-muted">
              {{ pom.hook || 'Producto recomendado para avanzar en tus metas.' }}
            </p>

            <div class="mt-6 flex flex-wrap gap-2">
              <span *ngFor="let tag of heroTags" class="chip">
                {{ tag }}
              </span>
            </div>

            <div class="mt-8 flex flex-col gap-3 sm:flex-row sm:items-center">
              <div class="flex items-center gap-3 rounded-2xl border border-olive-30 surface-soft p-3">
                <span class="text-sm text-gray-600">Cantidad</span>
                <ui-form-field type="number" [ngModel]="heroQty" (ngModelChange)="setHeroQty($event)"
                  inputClass="w-20 rounded-xl border border-olive-30 bg-white/70 px-3 py-2 text-sm text-main"></ui-form-field>
                <span class="flex items-center gap-2 text-sm text-gray-600">
                  x
                  <span class="font-semibold text-main">{{ formatMoney(discountedPrice(heroProductPrice)) }}</span>
                  <span *ngIf="hasDiscount" class="text-xs text-gray-500 line-through">
                    {{ formatMoney(heroProductPrice) }}
                  </span>
                  <span *ngIf="hasDiscount" class="text-[11px] text-accent">{{ discountAppliedLabel() }}</span>
                  <span *ngIf="!hasDiscount" class="text-[11px] text-gray-500">Sin descuento</span>
                </span>
              </div>

              <ui-button size="lg" variant="primary" (pressed)="addHeroToCart()">
                <i class="fa-solid fa-cart-plus" aria-hidden="true"></i>
                Agregar a carrito
              </ui-button>
            </div>
          </div>

          <div
            class="order-1 md:order-1 relative h-[260px] overflow-hidden rounded-3xl border border-olive-30 md:h-[360px]">

            <img [src]="heroImage" [alt]="pom.name" class="hero-image absolute inset-0 h-full w-full object-cover" />
            <div class="absolute inset-0 bg-black/45"></div>
            <div class="absolute -right-16 -top-16 h-64 w-64 rounded-full bg-gold-12 blur-3xl"></div>

            <div class="relative flex h-full flex-col justify-end p-6">
              <div class="text-sm font-semibold text-sand-200">Oferta estratégica</div>
              <div class="mt-1 text-xs text-sand-200">Optimiza tu corte de mes</div>
            </div>
          </div>
        </div>
        <div class="relative grid items-center gap-8 p-6 md:grid-cols-2 md:p-10" *ngIf="!productOfMonth">
          <div>
            <span
              class="inline-flex items-center gap-2 rounded-full border border-gold-35 bg-gold-20 px-4 py-2 text-xs font-semibold text-gold">
              <i class="fa-solid fa-star" aria-hidden="true"></i>
              Producto del mes
            </span>
            <h3 class="mt-5 text-3xl font-extrabold tracking-tight md:text-4xl">Producto destacado</h3>
            <p class="mt-3 max-w-xl text-muted">
              Aún no hay un producto del mes configurado.
            </p>
          </div>
        </div>
      </div>

      <div class="mt-10">
        <div class="flex flex-col gap-1 sm:flex-row sm:items-center sm:justify-between">
          <h3 class="flex items-center gap-2 text-xl font-bold">
            <i class="fa-solid fa-rotate text-accent" aria-hidden="true"></i>
            Volver a comprar
          </h3>
          <p class="text-sm text-gray-600 sm:text-right">
            Tus básicos para mantener metas constantes.
          </p>
        </div>

        <div class="mt-4 grid gap-4 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3">
          <ui-product-card *ngFor="let product of buyAgainProducts" [product]="product"
            [discountedPriceLabel]="formatMoney(discountedPrice(product.price))"
            [originalPriceLabel]="hasDiscount ? formatMoney(product.price) : ''"
            [discountLabel]="discountAppliedLabel()" [qty]="getCartQty(product.id)"
            (qtyChange)="updateCart(product.id, $event)" (viewDetails)="openProductDetails(product)"
            (add)="addQuick(product.id, 1)"></ui-product-card>
        </div>
      </div>


      <div class="mt-12">
        <div class="flex flex-col gap-1 sm:flex-row sm:items-center sm:justify-between">
          <h3 class="flex items-center gap-2 text-xl font-bold">
            <i class="fa-solid fa-layer-group text-accent" aria-hidden="true"></i>
            Todos los productos
          </h3>
          <div class="text-sm text-gray-600 sm:text-right">{{ productsCount }}</div>
        </div>

        <div class="mt-4 grid gap-4 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3">
          <ui-product-card *ngFor="let product of otherProducts" [product]="product"
            [discountedPriceLabel]="formatMoney(discountedPrice(product.price))"
            [originalPriceLabel]="hasDiscount ? formatMoney(product.price) : ''"
            [discountLabel]="discountAppliedLabel()" [qty]="getCartQty(product.id)"
            (qtyChange)="updateCart(product.id, $event)" (viewDetails)="openProductDetails(product)"
            (add)="addQuick(product.id, 1)"></ui-product-card>
        </div>
      </div>

    </section>

    <section id="red" class="scroll-mt-10" *ngIf="!isGuest">
      <div class="flex items-end justify-between gap-6">
        <div>
          <h2 class="flex items-center gap-3 text-3xl font-extrabold tracking-tight md:text-4xl">

            <i class="fa-solid fa-users hidden text-accent md:inline" aria-hidden="true"></i>
            Red
          </h2>
        </div>

      </div>

      <div class="mt-8 grid gap-6 lg:grid-cols-2">
        <div class="grain relative overflow-hidden rounded-3xl border border-olive-30 bg-ivory-80 p-6">
          <div class="pointer-events-none absolute inset-0 bg-olive-10">
          </div>
          <div class="relative flex items-center justify-between">
            <div>
              <h3 class="flex items-center gap-2 text-xl font-bold">
                <i class="fa-solid fa-users" aria-hidden="true"></i>
                Tu Red
              </h3>
            </div>
          </div>

          <div class="mt-6 overflow-hidden rounded-2xl border border-olive-30 surface-soft p-4">
            <ui-networkgraph class="block w-full" [nodes]="graphLayout.nodes" [links]="graphLayout.links"
              [viewBoxWidth]="graphSize.width" [viewBoxHeight]="graphSize.height" [heightPx]="graphSize.height"
              linkStyle="curved" labelMode="short">
            </ui-networkgraph>
          </div>

          <div *ngIf="hasInactiveIntermediate" class="callout mt-4 rounded-2xl px-4 py-3 text-xs">
            <i class="fa-solid fa-handshake-angle" aria-hidden="true"></i>
            <strong>Apoya a tu red:</strong> cuando hay inactivos en niveles L1, los beneficios de sus L2 no llegan
            hasta ti.
          </div>

          <ui-button size="sm" variant="ghost" *ngIf="levelOneCount === 0 && levelTwoCount === 0" type="button"
            class="mt-4" (pressed)="scrollToSection('links')">
            <i class="fa-solid fa-share-nodes" aria-hidden="true"></i>
            Compartir mi enlace
          </ui-button>
          <ui-button size="sm" variant="ghost" *ngIf="!isGuest" type="button" (pressed)="scrollToSection('ordenes')">
            <i class="fa-solid fa-receipt" aria-hidden="true"></i>
            Ordenes
          </ui-button>

          <ui-button size="sm" variant="ghost" *ngIf="!isGuest && commissionSummary" type="button"
            (pressed)="scrollToSection('comisiones')">
            <i class="fa-solid fa-wallet" aria-hidden="true"></i>
            Comisiones
          </ui-button>

          <div class="mt-4 grid grid-cols-3 gap-3 text-sm">
            <div class="progress-card p-4">
              <div class="title text-xs">Nivel 1</div>
              <div class="numbers mt-1 text-2xl font-extrabold">{{ levelOneCount }}</div>
            </div>
            <div class="progress-card p-4">
              <div class="title text-xs">Nivel 2</div>
              <div class="numbers mt-1 text-2xl font-extrabold">{{ levelTwoCount }}</div>
            </div>
            <div class="progress-card p-4">
              <div class="title text-xs">Activos</div>
              <div class="numbers mt-1 text-2xl font-extrabold">{{ activeCount }}</div>
            </div>
          </div>
        </div>

        <div class="grain relative overflow-hidden rounded-3xl border border-olive-30 bg-ivory-80 p-6">
          <div class="pointer-events-none absolute inset-0 bg-olive-10">
          </div>
          <div class="relative">
            <div *ngIf="networkMembers.length === 0" class="mb-6 rounded-2xl border border-gold-35 bg-gold-12 p-5">
              <div class="text-sm font-semibold text-gold">&#x1F3AF; Misi&#243;n de red</div>
              <div class="mt-2 text-lg font-extrabold">Invita a 1 persona y act&#237;vala este mes</div>
              <div class="mt-1 text-sm text-muted">Tu red se activa con tu primer miembro.</div>
              <div class="mt-4 flex flex-wrap gap-2">
                <ui-button size="sm" variant="primary" type="button" (pressed)="copyLinkAndCopy()">
                  <i class="fa-solid fa-copy" aria-hidden="true"></i>
                  Copiar link + copy
                </ui-button>
                <ui-button size="sm" variant="ghost" type="button" (pressed)="scrollToSection('links')">
                  <i class="fa-solid fa-share-nodes" aria-hidden="true"></i>
                  Compartir mi enlace
                </ui-button>
                <ui-button size="sm" variant="ghost" *ngIf="!isGuest" type="button"
                  (pressed)="scrollToSection('ordenes')">
                  <i class="fa-solid fa-receipt" aria-hidden="true"></i>
                  Ordenes
                </ui-button>

                <ui-button size="sm" variant="ghost" *ngIf="!isGuest && commissionSummary" type="button"
                  (pressed)="scrollToSection('comisiones')">
                  <i class="fa-solid fa-wallet" aria-hidden="true"></i>
                  Comisiones
                </ui-button>
                <ui-button size="sm" variant="ghost" type="button" (pressed)="scrollToSection('links')">
                  <i class="fa-solid fa-comment-dots" aria-hidden="true"></i>
                  Ver mensajes sugeridos
                </ui-button>
                <ui-button size="sm" variant="ghost" *ngIf="!isGuest" type="button"
                  (pressed)="scrollToSection('ordenes')">
                  <i class="fa-solid fa-receipt" aria-hidden="true"></i>
                  Ordenes
                </ui-button>

                <ui-button size="sm" variant="ghost" *ngIf="!isGuest && commissionSummary" type="button"
                  (pressed)="scrollToSection('comisiones')">
                  <i class="fa-solid fa-wallet" aria-hidden="true"></i>
                  Comisiones
                </ui-button>
              </div>
            </div>
            <div class="flex items-center justify-between">
              <div>
                <h3 class="flex items-center gap-2 text-xl font-bold">
                  <i class="fa-solid fa-chart-column" aria-hidden="true"></i>
                  Consumo mensual de tu red
                </h3>
              </div>

            </div>

            <div *ngIf="networkMembers.length === 0"
              class="mt-6 rounded-2xl border border-olive-30 surface-soft p-6 text-center">
              <div class="text-sm font-semibold text-main">A?n no tienes miembros en tu red</div>
              <div class="mt-1 text-xs text-gray-600">Comparte tu enlace para empezar</div>
              <ui-button type="button" variant="ghost" size="md" iconClass="fa-solid fa-share-nodes" extraClass="mt-4"
                (pressed)="scrollToSection('links')">
                Compartir mi enlace
              </ui-button>
              <ui-button *ngIf="!isGuest" type="button" variant="ghost" size="md" iconClass="fa-solid fa-receipt"
                (pressed)="scrollToSection('ordenes')">
                Ordenes
              </ui-button>

              <ui-button *ngIf="!isGuest && commissionSummary" type="button" variant="ghost" size="md"
                iconClass="fa-solid fa-wallet" (pressed)="scrollToSection('comisiones')">
                Comisiones
              </ui-button>
            </div>

            <ui-table *ngIf="networkMembers.length > 0" class="mt-6">
              <div class="table-soft">
                <ui-data-table [rows]="networkMembers">
                  <ng-template #mobileRow let-member>
                    <div class="p-4">
                      <div class="flex items-center justify-between">
                        <div class="text-sm font-semibold text-main">{{ member.name }}</div>
                        <ui-status-badge context="network" [status]="member.status"
                          [showIcon]="false"></ui-status-badge>
                      </div>
                      <div class="mt-2 grid gap-1 text-xs text-gray-600">
                        <div>Nivel: <span class="text-main">{{ member.level }}</span></div>
                        <div>Consumo mes: <span class="text-main">{{ formatMoney(member.spend) }}</span></div>
                      </div>
                    </div>
                  </ng-template>
                  <ng-template #desktopHeader>
                    <div class="grid grid-cols-4 border-b border-white/10 text-sm font-semibold">
                      <div class="px-4 py-3">Usuario</div>
                      <div class="px-4 py-3">Nivel</div>
                      <div class="px-4 py-3">Consumo mes</div>
                      <div class="px-4 py-3">Estado</div>
                    </div>
                  </ng-template>
                  <ng-template #desktopRow let-member>
                    <div class="grid grid-cols-4 text-sm">
                      <div class="px-4 py-3">{{ member.name }}</div>
                      <div class="muted px-4 py-3">{{ member.level }}</div>
                      <div class="px-4 py-3">{{ formatMoney(member.spend) }}</div>
                      <div class="px-4 py-3"><ui-status-badge context="network" [status]="member.status"
                          [showIcon]="false"></ui-status-badge></div>
                    </div>
                  </ng-template>
                </ui-data-table>
              </div>
            </ui-table>

            <div class="progress-card mt-6 p-5">
              <div class="flex items-center justify-between">
                <div>
                  <div class="title text-xs">Meta de red (este mes)</div>
                  <div class="numbers mt-1 text-lg font-extrabold">
                    {{ formatMoney(networkProgress) }} / {{ formatMoney(networkGoal) }}
                  </div>
                  <div class="title mt-1 text-xs">Te faltan {{ formatMoney(remainingNetworkGoal) }} para cumplir
                    la meta de red</div>
                </div>
              </div>

              <div class="progress relative mt-4 h-3">
                <div class="progress-fill" [style.width.%]="networkPercent"></div>
              </div>

            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="comisiones" class="scroll-mt-10" *ngIf="!isGuest && commissionSummary as commissions">
      <div class="flex items-end justify-between gap-6">
        <div>
          <h2 class="flex items-center gap-3 text-3xl font-extrabold tracking-tight md:text-4xl">

            <i class="fa-solid fa-coins hidden text-gold md:inline" aria-hidden="true"></i>
            Comisiones
          </h2>
          <p class="mt-2 text-sm text-gray-600">Resumen del mes {{ commissions.monthKey }}.</p>
        </div>
      </div>

      <div class="mt-6 grid gap-4 lg:grid-cols-[1.2fr_.8fr]">
        <div class="rounded-3xl border border-olive-30 bg-ivory-80 p-6">
          <div class="grid gap-3 sm:grid-cols-3">
            <ui-kpi-card label="Comisiones del mes" [value]="formatMoney(commissions.monthTotal || 0)"></ui-kpi-card>
            <ui-kpi-card label="Por confirmar" [value]="formatMoney(commissions.pendingTotal || 0)"></ui-kpi-card>
            <ui-kpi-card label="Bloqueadas" [value]="formatMoney(commissions.blockedTotal || 0)">
              <span kpi-label-extra class="relative inline-flex" (mouseleave)="showBlockedTooltip = false">
                <ui-button size="md" variant="ghost" type="button" class="text-main"
                  aria-label="Info comisiones bloqueadas" (pressed)="toggleBlockedTooltip()">
                  <i class="fa-solid fa-circle-info text-[11px]" aria-hidden="true"></i>
                </ui-button>
                <span *ngIf="showBlockedTooltip"
                  class="absolute left-0 top-full z-10 mt-2 w-52 rounded-lg border border-olive-30 bg-black/90 p-2 text-[11px] text-sand-200 shadow-lg">
                  Las comisiones que pasan por referidos inactivos no llegan a ti.
                </span>
              </span>
            </ui-kpi-card>
          </div>

          <div class="mt-4 flex flex-wrap items-center gap-3">
            <ui-button size="sm" variant="ghost" type="button" (pressed)="toggleCommissionLedger()">
              <i class="fa-solid" [ngClass]="showCommissionLedger ? 'fa-eye-slash' : 'fa-table'" aria-hidden="true"></i>
              {{ showCommissionLedger ? 'Ocultar detalles' : 'Ver detalles' }}
            </ui-button>
          </div>

          <ui-table *ngIf="showCommissionLedger" class="mt-4">
            <div class="table-soft">
              <ui-data-table [rows]="commissions.ledger || []">
                <ng-template #mobileRow let-row>
                  <div class="p-4">
                    <div class="flex items-center justify-between">
                      <div class="text-sm font-semibold text-main">{{ row.orderId || '-' }}</div>
                      <span [class]="commissionLedgerStatusClass(row.status)">{{
                        row.status || '-' }}</span>
                    </div>
                    <div class="mt-2 grid gap-1 text-xs text-gray-600">
                      <div>Nivel: <span class="text-main">L{{ row.level || '-' }}</span></div>
                      <div>Monto: <span class="text-main">{{ formatMoney(row.amount || 0) }}</span></div>
                      <div>Fecha: <span class="text-main">{{ formatLedgerDate(row.createdAt) }}</span></div>
                    </div>
                  </div>
                </ng-template>

                <ng-template #desktopHeader>
                  <div class="grid grid-cols-5 border-b border-white/10 text-sm font-semibold">
                    <div class="px-4 py-3">Orden</div>
                    <div class="px-4 py-3">Nivel</div>
                    <div class="px-4 py-3">Monto</div>
                    <div class="px-4 py-3">Estado</div>
                    <div class="px-4 py-3">Fecha</div>
                  </div>
                </ng-template>

                <ng-template #desktopRow let-row>
                  <div class="grid grid-cols-5 text-sm">
                    <div class="px-4 py-3">{{ row.orderId || '-' }}</div>
                    <div class="muted px-4 py-3">L{{ row.level || '-' }}</div>
                    <div class="px-4 py-3">{{ formatMoney(row.amount || 0) }}</div>
                    <div class="px-4 py-3"><span [class]="commissionLedgerStatusClass(row.status)">{{
                        row.status || '-' }}</span></div>
                    <div class="px-4 py-3 text-gray-600">{{ formatLedgerDate(row.createdAt) }}</div>
                  </div>
                </ng-template>
              </ui-data-table>

              <div *ngIf="(commissions.ledger?.length || 0) === 0" class="px-4 py-4 text-center text-xs text-gray-500">
                Sin movimientos este mes.</div>
            </div>
          </ui-table>

          <div class="mt-4 rounded-2xl border border-olive-30 surface-soft p-4 text-sm text-muted">
            <div class="flex items-center justify-between">
              <span>CLABE registrada</span>
              <span class="text-main">
                {{ commissions.clabeOnFile ? ('**** ' + (commissions.clabeLast4 || '')) : 'No registrada' }}
              </span>
            </div>
            <div class="mt-3 grid gap-3 sm:grid-cols-[1fr_auto]">
              <ui-form-field label="CLABE interbancaria" name="clabeDraft" placeholder="000000000000000000"
                [(ngModel)]="clabeDraft" wrapperClass="block text-xs"
                inputClass="mt-2 w-full rounded-2xl border border-olive-30 surface-soft px-4 py-2 text-sm text-main placeholder-text-muted-strong"></ui-form-field>
              <ui-button type="button" variant="primary" size="md" iconClass="fa-solid fa-floppy-disk"
                extraClass="self-end" (pressed)="openClabeConfirm()">
                Guardar
              </ui-button>
            </div>
            <div class="mt-2 text-xs text-gray-500">
              Depositos programados para el dia {{ commissions.payoutDay || 10 }} de cada mes.
            </div>
          </div>
        </div>

        <div class="rounded-3xl border border-olive-30 bg-ivory-80 p-6">
          <div class="text-sm font-semibold text-main">Mes anterior</div>
          <div class="mt-4 rounded-2xl border border-olive-30 surface-soft p-4">
            <div class="text-xs text-gray-600">Total</div>
            <div class="mt-1 text-2xl font-extrabold">{{ formatMoney(commissions.paidTotal || 0) }}</div>
            <div class="mt-2 text-xs text-gray-500">
              Estatus:
              <span [class]="commissionPrevStatusClass(commissions.prevStatus)">
                {{
                commissions.prevStatus === 'paid'
                ? 'Pagada'
                : commissions.prevStatus === 'pending'
                ? 'Pendiente de pago'
                : 'Sin movimientos'
                }}
              </span>
            </div>
            <ui-button *ngIf="commissions.prevStatus === 'paid' && commissions.prevReceiptUrl" variant="linkish"
              size="sm" iconClass="fa-solid fa-file-invoice" [fullWidth]="true" extraClass="mt-3"
              (click)="openCommissionReceipt(commissions.prevReceiptUrl)">
              Ver comprobante
            </ui-button>
          </div>
        </div>
      </div>
    </section>

    <section id="ordenes" class="scroll-mt-10" *ngIf="!isGuest">
      <div class="flex items-end justify-between gap-6">
        <div>
          <h2 class="flex items-center gap-3 text-3xl font-extrabold tracking-tight md:text-4xl">

            <i class="fa-solid fa-receipt hidden text-accent md:inline" aria-hidden="true"></i>
            Ordenes
          </h2>
          <p class="mt-2 text-sm text-gray-600">Seguimiento de tus pedidos recientes.</p>
        </div>
      </div>

      <div class="mt-6 rounded-3xl border border-olive-30 bg-ivory-80 p-6">
        <div *ngIf="isOrdersLoading" class="text-sm text-gray-600">Cargando ordenes...</div>
        <div *ngIf="!isOrdersLoading && orders.length === 0" class="text-sm text-gray-600">
          Aun no tienes ordenes registradas.
        </div>
        <ui-table *ngIf="!isOrdersLoading && orders.length > 0">
          <div class="table-soft">
            <ui-data-table [rows]="orders">
              <ng-template #mobileRow let-order>
                <div class="p-4">
                  <div class="flex items-center justify-between">
                    <div class="text-sm font-semibold text-main">{{ order.id }}</div>
                    <ui-status-badge [status]="order.status || ''"></ui-status-badge>
                  </div>
                  <div class="mt-2 grid gap-1 text-xs text-gray-600">
                    <div>Fecha: <span class="text-main">{{ order.createdAt || '-' }}</span></div>
                    <div>Total: <span class="text-main">{{ formatMoney(order.total) }}</span></div>
                  </div>
                  <ui-button variant="ghost" size="sm" [fullWidth]="true" extraClass="mt-3"
                    [routerLink]="['/orden', order.id]">Ver orden</ui-button>
                </div>
              </ng-template>
              <ng-template #desktopHeader>
                <div class="grid grid-cols-[1fr_1fr_1fr_1fr_auto] border-b border-white/10 text-sm font-semibold">
                  <div class="px-4 py-3">Orden</div>
                  <div class="px-4 py-3">Fecha</div>
                  <div class="px-4 py-3">Total</div>
                  <div class="px-4 py-3">Estado</div>
                  <div class="px-4 py-3 text-right">Ver</div>
                </div>
              </ng-template>
              <ng-template #desktopRow let-order>
                <div class="grid grid-cols-[1fr_1fr_1fr_1fr_auto] items-center text-sm">
                  <div class="px-4 py-3">{{ order.id }}</div>
                  <div class="muted px-4 py-3">{{ order.createdAt || '-' }}</div>
                  <div class="px-4 py-3">{{ formatMoney(order.total) }}</div>
                  <div class="px-4 py-3"><ui-status-badge [status]="order.status || ''"></ui-status-badge></div>
                  <div class="px-4 py-3 text-right"><ui-button variant="ghost" size="sm"
                      [routerLink]="['/orden', order.id]">Ver orden</ui-button></div>
                </div>
              </ng-template>
            </ui-data-table>
          </div>
        </ui-table>
      </div>
    </section>

    <section id="links" class="scroll-mt-10" *ngIf="!isGuest">
      <div class="flex items-end justify-between gap-6">
        <div>
          <h2 class="flex items-center gap-3 text-3xl font-extrabold tracking-tight md:text-4xl">

            <i class="fa-solid fa-link hidden text-gold md:inline" aria-hidden="true"></i>
            Links de referencia
          </h2>
        </div>
      </div>

      <div class="mt-8 grid gap-6 lg:grid-cols-1">
        <div class="grain relative overflow-hidden rounded-3xl border border-olive-30 bg-ivory-80 p-6">
          <div class="pointer-events-none absolute inset-0 bg-olive-10">
          </div>



          <div *ngIf="networkMembers.length === 0" class="mb-6 rounded-2xl border border-gold-35 bg-gold-12 p-5">
            <div class="text-sm font-semibold text-gold">&#x1F3AF; Misi&#243;n de red</div>
            <div class="mt-2 text-lg font-extrabold">Invita a 1 persona y act&#237;vala este mes</div>
            <div class="mt-1 text-sm text-muted">Tu red se activa con tu primer miembro.</div>
            <div class="mt-4 flex flex-wrap gap-2">
              <ui-button size="sm" variant="primary" type="button" (pressed)="copyLinkAndCopy()">
                <i class="fa-solid fa-copy" aria-hidden="true"></i>
                Copiar link + copy
              </ui-button>
              <ui-button size="sm" variant="ghost" type="button" (pressed)="scrollToSection('links')">
                <i class="fa-solid fa-share-nodes" aria-hidden="true"></i>
                Compartir mi enlace
              </ui-button>
              <ui-button *ngIf="!isGuest" type="button" variant="ghost" size="md" iconClass="fa-solid fa-receipt"
                (pressed)="scrollToSection('ordenes')">
                Ordenes
              </ui-button>

              <ui-button *ngIf="!isGuest && commissionSummary" type="button" variant="ghost" size="md"
                iconClass="fa-solid fa-wallet" (pressed)="scrollToSection('comisiones')">
                Comisiones
              </ui-button>
              <ui-button size="sm" variant="ghost" type="button" (pressed)="scrollToSection('links')">
                <i class="fa-solid fa-comment-dots" aria-hidden="true"></i>
                Ver mensajes sugeridos
              </ui-button>
              <ui-button *ngIf="!isGuest" type="button" variant="ghost" size="md" iconClass="fa-solid fa-receipt"
                (pressed)="scrollToSection('ordenes')">
                Ordenes
              </ui-button>

              <ui-button *ngIf="!isGuest && commissionSummary" type="button" variant="ghost" size="md"
                iconClass="fa-solid fa-wallet" (pressed)="scrollToSection('comisiones')">
                Comisiones
              </ui-button>
            </div>
          </div>

          <div class="mb-6 rounded-2xl border border-olive-30 surface-soft p-4">
            <div class="flex items-center gap-2 text-xs font-semibold text-gray-600">
              <i class="fa-solid fa-route" aria-hidden="true"></i>
              Tu flujo de 3 pasos
            </div>
            <div class="mt-3 space-y-3 text-sm">
              <div class="flex items-center gap-3">
                <div class="flex h-8 w-8 items-center justify-center rounded-full border text-sm font-semibold"
                  [ngClass]="activeFeaturedId ? 'border-olive-30 bg-emerald-500/10 text-accent' : 'border-olive-30 bg-ivory-80 text-muted'">
                  <i *ngIf="activeFeaturedId" class="fa-solid fa-check" aria-hidden="true"></i>
                  <span *ngIf="!activeFeaturedId">1</span>
                </div>
                <div>
                  <div class="font-semibold text-main">Elige gancho</div>
                  <div class="text-xs text-gray-500">Selecciona tu producto destacado.</div>
                </div>
              </div>
              <div class="flex items-center gap-3">
                <div class="flex h-8 w-8 items-center justify-center rounded-full border text-sm font-semibold"
                  [ngClass]="hasCopiedLink ? 'border-olive-30 bg-emerald-500/10 text-accent' : 'border-olive-30 bg-ivory-80 text-muted'">
                  <i *ngIf="hasCopiedLink" class="fa-solid fa-check" aria-hidden="true"></i>
                  <span *ngIf="!hasCopiedLink">2</span>
                </div>
                <div>
                  <div class="font-semibold text-main">Copia tu link</div>
                  <div class="text-xs text-gray-500">Pegalo en tu bio o chat.</div>
                </div>
              </div>
              <div class="flex items-center gap-3">
                <div class="flex h-8 w-8 items-center justify-center rounded-full border text-sm font-semibold"
                  [ngClass]="(hasCopiedCopy || hasCopiedAsset) ? 'border-olive-30 bg-emerald-500/10 text-accent' : 'border-olive-30 bg-ivory-80 text-muted'">
                  <i *ngIf="hasCopiedCopy || hasCopiedAsset" class="fa-solid fa-check" aria-hidden="true"></i>
                  <span *ngIf="!(hasCopiedCopy || hasCopiedAsset)">3</span>
                </div>
                <div>
                  <div class="font-semibold text-main">Publica</div>
                  <div class="text-xs text-gray-500">Copy + creatividades listas.</div>
                </div>
              </div>
            </div>
          </div>

          <div class="relative">
            <h3 class="flex items-center gap-2 text-xl font-bold">
              <i class="fa-solid fa-bullseye" aria-hidden="true"></i>
              Selecciona tu gancho
            </h3>

            <div class="mt-5 grid gap-3 sm:grid-cols-2">
              <ui-button *ngFor="let item of pagedFeatured"   class="w-full h-full"
                [variant]="item.id === activeFeaturedId ? 'primary' : 'ghost'" [stacked]="true"
                (pressed)="setFeatured(item.id)">
                <span btnTitle>{{ item.label }}</span>
                <span btnSubtitle>{{ item.hook }}</span>
              </ui-button>
            </div>

            <div class="mt-4 flex items-center justify-between">
              <ui-button size="sm" variant="ghost" type="button" [disabled]="!canPrevFeatured"
                [ngClass]="!canPrevFeatured ? 'opacity-50 cursor-not-allowed' : ''" (pressed)="prevFeaturedPage()">
                <i class="fa-solid fa-chevron-left" aria-hidden="true"></i>
                Atras
              </ui-button>
              <ui-button size="sm" variant="ghost" type="button" [disabled]="!canNextFeatured"
                [ngClass]="!canNextFeatured ? 'opacity-50 cursor-not-allowed' : ''" (pressed)="nextFeaturedPage()">
                Siguiente
                <i class="fa-solid fa-chevron-right" aria-hidden="true"></i>
              </ui-button>
            </div>

            <div class="mt-6 rounded-2xl border border-olive-30 surface-soft p-4">
              <div class="flex items-center gap-2 text-xs text-gray-600">
                <i class="fa-solid fa-link" aria-hidden="true"></i>
                Tu link
              </div>
              <div class="mt-2 flex flex-col gap-3 sm:flex-row">
                <ui-form-field wrapperClass="flex-1" [readonly]="true" [ngModel]="referralLink"  class="w-full h-full"
                  inputClass="w-full rounded-2xl border border-olive-30 surface-soft px-4 py-3 text-sm text-main"></ui-form-field>
                <div class="flex flex-1 flex-col gap-2 sm:flex-row sm:justify-end">
                  <ui-button size="sm" variant="primary" (pressed)="copyLink()">
                    <i class="fa-solid fa-copy" aria-hidden="true"></i>
                    Copiar
                  </ui-button>
                </div>
              </div>
              <div class="mt-2 text-xs text-gray-500">
                Tip: fija el link en tu bio y rep&#237;telo en 3 historias.
              </div>
            </div>
          </div>
          <div class="relative mt-6">

            <div class="flex items-center justify-between">
              <div>
                <h3 class="flex items-center gap-2 text-xl font-bold">
                  <i class="fa-brands fa-instagram" aria-hidden="true"></i>
                  Redes Sociales
                </h3>
              </div>

              <div class="flex flex-wrap gap-2">
                <ui-button size="sm" [variant]="socialChannel === 'whatsapp' ? 'primary' : 'ghost'"
                  (pressed)="setChannel('whatsapp')">
                  <i class="fa-brands fa-whatsapp" aria-hidden="true"></i>
                  WhatsApp
                </ui-button>
                <ui-button size="sm" [variant]="socialChannel === 'instagram' ? 'primary' : 'ghost'"
                  (pressed)="setChannel('instagram')">
                  <i class="fa-brands fa-instagram" aria-hidden="true"></i>
                  Instagram
                </ui-button>
                <ui-button size="sm" [variant]="socialChannel === 'facebook' ? 'primary' : 'ghost'"
                  (pressed)="setChannel('facebook')">
                  <i class="fa-brands fa-facebook-f" aria-hidden="true"></i>
                  Facebook
                </ui-button>
              </div>
            </div>

            <div class="mt-6 grid gap-4 md:grid-cols-2">
              <div class="overflow-hidden rounded-2xl border border-olive-30 surface-soft">
                <div class="bg-ivory-80 px-4 py-3 text-sm font-semibold text-main">
                  Optimizado para {{ socialChannel === 'whatsapp' ? 'WhatsApp' : (socialChannel === 'instagram' ?
                  'Instagram' : 'Facebook') }}
                </div>
                <div class="p-4">
                  <div class="bg-ambient relative w-full overflow-hidden rounded-2xl border border-olive-30"
                    [style.aspect-ratio]="socialAspectRatio">
                    <img [src]="activeSocialAsset" alt="Social"
                      class="hero-image absolute inset-0 h-full w-full object-cover" />
                    <div class="absolute inset-0 bg-black/45">
                    </div>
                    <div class="absolute bottom-0 left-0 right-0 p-4">
                      <div class="text-xs font-semibold text-sand-200">OBTENERLO AHORA</div>
                      <div class="text-lg font-extrabold leading-tight text-sand-200">{{ activeFeatured.label }}</div>
                      <div class="mt-1 text-xs text-sand-200">Link en bio / swipe up</div>
                    </div>
                  </div>

                  <div class="mt-4 flex items-center justify-between gap-3">
                    <!--div class="text-xs text-gray-500">
                      Imagen: <span class="text-muted">{{ activeSocialAsset }}</span>
                    </div-->
                    <ui-button size="sm" variant="primary" (pressed)="copyAssetPath()">
                      <i class="fa-solid fa-copy" aria-hidden="true"></i>
                      Copiar ruta
                    </ui-button>
                  </div>
                </div>
              </div>



              <div class="rounded-2xl border border-olive-30 surface-soft p-4">
                <div class="flex items-center gap-2 text-sm font-semibold text-main">
                  <i class="fa-solid fa-pen-nib" aria-hidden="true"></i>
                  {{ socialChannel === 'instagram' ? 'Descripción sugerida (editable)' : (socialChannel === 'facebook' ?
                  'Comentario sugerido (editable)' : 'Mensaje sugerido (editable)') }}
                </div>
                <ui-form-field wrapperClass="mt-3 block" kind="textarea" [rows]="10"
                  placeholder="Escribe tu copy aquí..." [ngModel]="captionText"
                  (ngModelChange)="captionText = $event; lastAutoCaption = false"
                  inputClass="w-full rounded-2xl border border-olive-30 surface-soft px-4 py-3 text-sm text-main placeholder-text-muted-strong"></ui-form-field>
                <div class="mt-3 flex gap-3">
                  <ui-button size="sm" variant="primary" class="flex-1" (pressed)="copyCaption()">
                    <i class="fa-solid fa-copy" aria-hidden="true"></i>
                    {{ socialChannel === 'instagram' ? 'Copiar descripción' : (socialChannel === 'facebook' ? 'Copiar
                    comentario' : 'Copiar mensaje') }}
                  </ui-button>
                  <!--button
                    class="inline-flex flex-1 items-center justify-center gap-2 rounded-full border border-olive-30 bg-ivory-80 px-5 py-3  hover-bg-cream-90"
                    (click)="generateTemplate()">
                    <i class="fa-solid fa-wand-magic-sparkles" aria-hidden="true"></i>
                    Generar template
                  </button-->
                </div>
                <div class="mt-2 text-xs text-gray-500">
                  Recomendación UX: 1 promesa + 1 prueba + 1 CTA. Evita promesas financieras.
                </div>
              </div>
            </div>

          </div>
        </div>


      </div>
    </section>
  </main>

  <div class="fixed bottom-5 left-1/2 z-50 -translate-x-1/2" [class.hidden]="!isToastVisible">
    <div
      class="rounded-full border border-olive-30 surface-soft px-5 py-3 text-sm text-main shadow-[0_20px_60px_rgba(0,0,0,0.6)]">
      {{ toastMessage }}
    </div>
  </div>

  <ui-modal [isOpen]="isCommissionModalOpen" maxWidthClass="max-w-lg" contentClass="p-6"
    (closed)="closeCommissionModal()">
    <div class="flex items-start justify-between">
      <div>
        <div class="text-xs font-semibold text-gray-600">Solicitud de pago</div>
        <h3 class="mt-2 text-xl font-extrabold">CLABE interbancaria</h3>
        <p class="mt-2 text-sm text-muted">Usaremos esta CLABE para depositar tus comisiones.</p>
      </div>
      <ui-button type="button" variant="ghost" size="sm" iconClass="fa-solid fa-xmark"
        (pressed)="closeCommissionModal()">
      </ui-button>
    </div>

    <div class="mt-6 grid gap-3">
      <ui-form-field kind="input" type="text" name="commissionClabe" [(ngModel)]="commissionClabe"
        label="CLABE (18 dígitos)" placeholder="000000000000000000" wrapperClass="block"
        inputClass="mt-2 w-full rounded-2xl border border-olive-30 surface-soft px-4 py-3 text-sm text-main placeholder-text-muted-strong"></ui-form-field>

      <div class="mt-2 flex flex-col gap-3 sm:flex-row sm:justify-end">
        <ui-button type="button" variant="ghost" size="md" (pressed)="closeCommissionModal()">
          Cancelar
        </ui-button>
        <ui-button type="button" [disabled]="isCommissionSubmitting" variant="primary" size="md"
          iconClass="fa-solid fa-paper-plane" (pressed)="submitCommissionRequest()">
          {{ isCommissionSubmitting ? 'Enviando...' : 'Solicitar pago' }}
        </ui-button>
      </div>
    </div>
  </ui-modal>

  <ui-modal [isOpen]="isClabeConfirmOpen" maxWidthClass="max-w-lg" contentClass="p-6" (closed)="closeClabeConfirm()">
    <div class="flex items-start justify-between">
      <div>
        <div class="text-xs font-semibold text-gray-600">Confirmacion</div>
        <h3 class="mt-2 text-xl font-extrabold">Actualizar CLABE interbancaria</h3>
        <p class="mt-2 text-sm text-muted">
          Estas a punto de guardar la CLABE:
          <span class="text-main">{{ clabePending }}</span>
        </p>
      </div>
      <ui-button type="button" variant="ghost" size="sm" iconClass="fa-solid fa-xmark" (pressed)="closeClabeConfirm()">
      </ui-button>
    </div>

    <div class="mt-6 flex flex-col gap-3 sm:flex-row sm:justify-end">
      <ui-button type="button" variant="ghost" size="md" (pressed)="closeClabeConfirm()">
        Cancelar
      </ui-button>
      <ui-button type="button" [disabled]="isClabeSaving" variant="primary" size="md" iconClass="fa-solid fa-check"
        (pressed)="saveCustomerClabe()">
        {{ isClabeSaving ? 'Guardando...' : 'Confirmar' }}
      </ui-button>
    </div>
  </ui-modal>

  <ui-modal [isOpen]="showGuestRegisterModal" maxWidthClass="max-w-lg" contentClass="p-6"
    (closed)="closeGuestRegisterModal()">
    <div class="flex items-start justify-between">
      <div>
        <div class="text-xs font-semibold text-gray-600">Registro rapido</div>
        <h3 class="mt-2 text-xl font-extrabold">Crea tu cuenta y desbloquea beneficios</h3>
        <p class="mt-2 text-sm text-muted">Completa tus datos para activar descuentos y red.</p>
      </div>
      <ui-button type="button" variant="ghost" size="sm" iconClass="fa-solid fa-xmark"
        (pressed)="closeGuestRegisterModal()">
      </ui-button>
    </div>

    <div class="mt-6 grid gap-3">
      <ui-form-field name="guestName" [(ngModel)]="guestRegisterForm.name" label="Nombre completo"
        placeholder="Tu nombre" wrapperClass="block"
        inputClass="mt-2 w-full rounded-2xl border border-olive-30 surface-soft px-4 py-3 text-sm text-main placeholder-text-muted-strong">
      </ui-form-field>
      <ui-form-field kind="input" type="email" name="guestEmail" [(ngModel)]="guestRegisterForm.email" label="Correo"
        placeholder="tucorreo@ejemplo.com" wrapperClass="block"
        inputClass="mt-2 w-full rounded-2xl border border-olive-30 surface-soft px-4 py-3 text-sm text-main placeholder-text-muted-strong">
      </ui-form-field>
      <ui-form-field kind="input" type="tel" name="guestPhone" [(ngModel)]="guestRegisterForm.phone" label="Teléfono"
        placeholder="+52 ..." wrapperClass="block"
        inputClass="mt-2 w-full rounded-2xl border border-olive-30 surface-soft px-4 py-3 text-sm text-main placeholder-text-muted-strong">
      </ui-form-field>
      <ui-form-field kind="input" type="password" name="guestPassword" [(ngModel)]="guestRegisterForm.password"
        label="Contraseña" placeholder="Mínimo 8 caracteres" wrapperClass="block"
        inputClass="mt-2 w-full rounded-2xl border border-olive-30 surface-soft px-4 py-3 text-sm text-main placeholder-text-muted-strong">
      </ui-form-field>
      <ui-form-field kind="input" type="password" name="guestConfirmPassword"
        [(ngModel)]="guestRegisterForm.confirmPassword" label="Confirmar contraseña" placeholder="Repite tu contraseña"
        wrapperClass="block"
        inputClass="mt-2 w-full rounded-2xl border border-olive-30 surface-soft px-4 py-3 text-sm text-main placeholder-text-muted-strong">
      </ui-form-field>

      <div class="mt-2 flex flex-col gap-3 sm:flex-row sm:justify-end">
        <ui-button type="button" variant="ghost" size="md" (pressed)="closeGuestRegisterModal()">
          Ahora no
        </ui-button>
        <ui-button type="button" [disabled]="isGuestRegisterSubmitting" variant="primary" size="md"
          iconClass="fa-solid fa-user-check" (pressed)="submitGuestRegister()">
          {{ isGuestRegisterSubmitting ? 'Creando cuenta...' : 'Regístrate' }}
        </ui-button>
      </div>
      <p *ngIf="guestRegisterFeedback" class="text-center text-xs"
        [class.text-alert-soft]="guestRegisterFeedbackType === 'error'"
        [class.text-accent]="guestRegisterFeedbackType === 'success'">
        {{ guestRegisterFeedback }}
      </p>
    </div>
  </ui-modal>

  <ui-modal [isOpen]="isProductDetailsOpen && !!selectedProduct" maxWidthClass="max-w-lg"
    contentClass="relative max-h-[90vh] overflow-y-auto p-6" (closed)="closeProductDetails()">
    <ng-container *ngIf="selectedProduct as product">
      <div class="flex items-start justify-between gap-3">
        <div>
          <div class="text-xs font-semibold text-gray-600">Detalle del producto</div>
          <h3 class="mt-2 text-xl font-extrabold text-main">{{ product.name }}</h3>
          <p class="muted mt-1 text-sm">{{ product.badge }}</p>
        </div>
        <ui-button type="button" variant="ghost" size="sm" iconClass="fa-solid fa-xmark"
          (click)="closeProductDetails()">
        </ui-button>
      </div>

      <div class="mt-5 grid gap-4 sm:grid-cols-[120px_1fr]">
        <div class="h-28 w-28 overflow-hidden rounded-2xl border border-olive-30 bg-ivory-80">
          <img [src]="product.img" [alt]="product.name" class="h-full w-full object-cover" />
        </div>
        <div>
          <div class="text-xs text-gray-600">Precio</div>
          <div class="mt-1 flex items-end gap-2">
            <div *ngIf="hasDiscount" class="text-sm text-gray-500 line-through">
              {{ formatMoney(product.price) }}
            </div>
            <div class="text-lg font-extrabold text-main">
              {{ formatMoney(discountedPrice(product.price)) }}
            </div>
            <div class="text-xs" [ngClass]="hasDiscount ? 'text-accent' : 'text-gray-500'">
              {{ discountAppliedLabel() }}
            </div>
          </div>
          <div class="mt-3 text-xs text-gray-600">Cantidad actual: {{ getCartQty(product.id) }}</div>
        </div>
      </div>

      <div *ngIf="product.description" class="divider mt-4 pt-4">
        <div class="text-xs font-semibold text-gray-600">Descripción</div>
        <p class="mt-2 whitespace-pre-line text-sm text-main">{{ product.description }}</p>
      </div>

      <div class="mt-6 flex flex-col gap-2 sm:flex-row sm:justify-end">
        <ui-button type="button" variant="ghost" size="md" (pressed)="closeProductDetails()">
          Cerrar
        </ui-button>
        <ui-button type="button" variant="primary" size="lg" iconClass="fa-solid fa-cart-plus"
          (pressed)="addQuick(product.id, 1)">
          Agregar a carrito
        </ui-button>
      </div>
    </ng-container>
  </ui-modal>

  <ui-modal [isOpen]="isGoalsModalOpen" maxWidthClass="max-w-md sm:max-w-lg"
    contentClass="relative max-h-[90vh] overflow-y-auto p-4 sm:p-6" (closed)="closeGoalsModal()">
    <!-- Header -->
    <div class="flex items-start justify-between gap-3">
      <div class="min-w-0">
        <div class="text-[11px] font-semibold text-gray-600">
          Metas cumplidas del mes
        </div>
        <h3 class="mt-1 text-lg sm:text-xl font-extrabold leading-tight">
          ¡Buen trabajo!
        </h3>
        <p class="mt-1 text-xs sm:text-sm text-muted">
          Estas son tus metas alcanzadas en el mes.
        </p>
      </div>

      <ui-button size="sm" variant="ghost" type="button" class="shrink-0" (pressed)="closeGoalsModal()">
        <i class="fa-solid fa-xmark" aria-hidden="true"></i>
      </ui-button>
    </div>

    <!-- List -->
    <div class="mt-4 sm:mt-5 space-y-2 sm:space-y-3">
      <div *ngFor="let goal of pagedAchievedGoals" class="rounded-2xl border border-olive-30 bg-sand-300 p-3 sm:p-4"
        [ngClass]="isNewAchievedGoal(goal) && isGoalsHighlight ? 'goal-epic-card' : ''"
        [style.--goal-delay]="newGoalDelay(goal)">
        <div *ngIf="isNewAchievedGoal(goal) && isGoalsHighlight" class="goal-epic-layer" aria-hidden="true">
          <div class="goal-epic-burst"></div>
          <div class="goal-epic-spark spark-1"></div>
          <div class="goal-epic-spark spark-4"></div>
        </div>

        <div class="flex items-start justify-between gap-3">
          <div class="min-w-0">
            <div class="text-[11px] sm:text-xs text-gray-600 leading-snug">
              {{ goal.subtitle }}
            </div>
            <div class="mt-0.5 text-xs sm:text-sm font-semibold text-main
         break-words whitespace-normal leading-snug line-clamp-2">
              {{ goal.title }}
            </div>
          </div>

          <!-- Badges compactos + wrap -->
          <div class="flex flex-wrap items-center justify-end gap-1.5 sm:gap-2">
            <span *ngIf="isNewAchievedGoal(goal)" class="inline-flex items-center gap-1 rounded-full border border-gold-35
                     bg-gold-12 px-2 py-0.5 text-[11px] text-gold">
              <i class="fa-solid fa-star text-[11px]" aria-hidden="true"></i>
              Nueva
            </span>

            <span *ngIf="!isNewAchievedGoal(goal)" class="inline-flex items-center gap-1 rounded-full border border-olive-30
                     bg-sand-100 px-2 py-0.5 text-[11px] text-main">
              <i class="fa-solid fa-eye text-[11px]" aria-hidden="true"></i>
              Leída
            </span>

            <span class="inline-flex items-center gap-1 rounded-full border border-emerald-400/30
                     bg-emerald-400/10 px-2 py-0.5 text-[11px] text-accent">
              <i class="fa-solid fa-check text-[11px]" aria-hidden="true"></i>
              OK
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="mt-4 sm:mt-5 flex flex-col gap-2 sm:gap-3 sm:flex-row sm:items-center sm:justify-between">
      <div *ngIf="achievedGoalsTotalPages > 1" class="flex items-center justify-between gap-2">
        <ui-button size="sm" variant="ghost" type="button" [disabled]="!canPrevAchievedGoals"
          (pressed)="prevAchievedGoalsPage()">
          <i class="fa-solid fa-chevron-left" aria-hidden="true"></i>
          Anterior
        </ui-button>

        <div class="text-[11px] text-gray-600">
          {{ achievedGoalsPage + 1 }} / {{ achievedGoalsTotalPages }}
        </div>

        <ui-button size="sm" variant="ghost" type="button" [disabled]="!canNextAchievedGoals"
          (pressed)="nextAchievedGoalsPage()">
          Siguiente
          <i class="fa-solid fa-chevron-right" aria-hidden="true"></i>
        </ui-button>
      </div>

      <ui-button size="sm" variant="primary" type="button" (pressed)="closeGoalsModal()">
        Listo
      </ui-button>
    </div>
  </ui-modal>

  <div *ngIf="cartTotal > 0" class="fixed bottom-6 right-6 z-40 md:hidden">
    <ui-button size="lg" variant="primary" type="button" (pressed)="goToCart()">
      <i class="fa-solid fa-basket-shopping" aria-hidden="true"></i>
      Ver carrito
    </ui-button>
  </div>

  <ui-footer></ui-footer>
</section>
